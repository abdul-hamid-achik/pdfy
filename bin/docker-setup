#!/bin/bash
set -e

echo "ğŸš€ Setting up PDFy with Docker..."

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo "âŒ Docker is not running. Please start Docker and try again."
  exit 1
fi

echo "âœ“ Docker is running"

# Build the containers
echo "ğŸ“¦ Building Docker containers..."
docker-compose build

# Start the services
echo "ğŸƒ Starting services..."
docker-compose up -d db redis minio

# Wait for services to be ready
echo "â³ Waiting for services to be ready..."
sleep 10

# Create MinIO bucket
echo "ğŸª£ Creating MinIO bucket..."
docker-compose exec -T minio mc alias set local http://localhost:9000 minioadmin minioadmin || true
docker-compose exec -T minio mc mb local/pdfy-development --ignore-existing || true

# Setup the database
echo "ğŸ—„ï¸ Setting up database..."
docker-compose run --rm web bin/rails db:create db:migrate db:seed

# Start the web service
echo "ğŸŒ Starting web service..."
docker-compose up -d web css js

# Run the validation test
echo "ğŸ§ª Running validation tests..."
docker-compose exec web ruby test/docker_test.rb

echo "
âœ… PDFy is ready!

ğŸ”— Access the application at: http://localhost:3001
ğŸ‘¤ Default users:
   - Admin: admin@example.com / password
   - User: user@example.com / password
   
ğŸ“Š MinIO Console: http://localhost:9001
   - Username: minioadmin
   - Password: minioadmin

ğŸ“ To get API keys for dynamic data:
   - Weather: https://openweathermap.org/api
   - Stocks: https://www.alphavantage.co/support/#api-key
   - News: https://newsapi.org/register

ğŸ’¡ Tips:
   - View logs: docker-compose logs -f
   - Stop services: docker-compose down
   - Reset everything: docker-compose down -v
"